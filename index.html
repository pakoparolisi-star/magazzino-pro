<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Magazzino</title>

<style>
body{
  font-family:-apple-system;
  background:#f2f2f7;
  margin:0;
  padding:8px;
}
h1{text-align:center;margin:8px 0}

.card{
  background:#fff;
  border-radius:8px;
  padding:6px 8px;
  margin-bottom:6px;
}

.prod{
  border-left:6px solid #000;
}

.qty{
  font-size:18px;
  font-weight:700;
}

input,button{
  font-size:14px;
  padding:6px;
}

.controls button{
  min-width:38px;
  border:none;
  border-radius:6px;
  color:#fff;
}

.plus{background:#2ecc71}
.minus{background:#e74c3c}
.move{background:#999}

.small{
  font-size:12px;
  padding:4px 6px;
}
</style>
</head>

<body>
<h1>ðŸ“¦ Magazzino</h1>

<div class="card">
  <input id="cat" placeholder="Categoria">
  <input id="name" placeholder="Prodotto">
  <input type="color" id="color" value="#000000">
  <button onclick="add()">Salva</button>
</div>

<div id="list"></div>

<script>
let db, scrollY=0;

const req=indexedDB.open("magazzinoDB",3);

req.onupgradeneeded=e=>{
  db=e.target.result;
  const st=db.createObjectStore("prodotti",{keyPath:"id",autoIncrement:true});
  st.createIndex("ordine","ordine");
};

req.onsuccess=e=>{
  db=e.target.result;
  render();
};

function up(v){return v.toUpperCase();}

function add(){
  const nome=up(name.value.trim());
  if(!nome)return;

  const tx=db.transaction("prodotti","readwrite");
  const st=tx.objectStore("prodotti");

  let maxOrd=0;
  st.openCursor().onsuccess=e=>{
    const c=e.target.result;
    if(c){
      maxOrd=Math.max(maxOrd,c.value.ordine);
      c.continue();
    }else{
      st.add({
        categoria:up(cat.value),
        nome,
        colore:color.value,
        qty:0,
        ordine:maxOrd+1
      });
    }
  };

  tx.oncomplete=()=>{
    name.value="";
    render();
  };
}

function render(){
  scrollY=window.scrollY;
  list.innerHTML="";
  const tx=db.transaction("prodotti","readonly");
  const idx=tx.objectStore("prodotti").index("ordine");

  idx.openCursor().onsuccess=e=>{
    const c=e.target.result;
    if(c){
      const p=c.value;
      const d=document.createElement("div");
      d.className="card prod";
      d.style.borderLeftColor=p.colore;
      d.innerHTML=`
<b>${p.categoria}</b><br>
${p.nome}
<div class="qty">${p.qty}</div>
<div class="controls">
${[-10,-5,-4,-3,-2,-1].map(n=>`<button class="minus" onclick="upd(${p.id},${n})">${n}</button>`).join("")}
${[1,2,3,4,5,10].map(n=>`<button class="plus" onclick="upd(${p.id},${n})">+${n}</button>`).join("")}
</div>
<button class="move small" onclick="move(${p.id},-1)">â–²</button>
<button class="move small" onclick="move(${p.id},1)">â–¼</button>
<button class="small" onclick="reset(${p.id})">Reset</button>
<button class="small" onclick="del(${p.id})">Elimina</button>
`;
      list.appendChild(d);
      c.continue();
    }else{
      window.scrollTo(0,scrollY);
    }
  };
}

function upd(id,n){
  const tx=db.transaction("prodotti","readwrite");
  const st=tx.objectStore("prodotti");
  st.get(id).onsuccess=e=>{
    const p=e.target.result;
    p.qty+=n;
    st.put(p);
  };
  tx.oncomplete=render;
}

function reset(id){
  if(!confirm("Azzerare?"))return;
  const tx=db.transaction("prodotti","readwrite");
  const st=tx.objectStore("prodotti");
  st.get(id).onsuccess=e=>{
    const p=e.target.result;
    p.qty=0;
    st.put(p);
  };
  tx.oncomplete=render;
}

function del(id){
  if(!confirm("Eliminare?"))return;
  const tx=db.transaction("prodotti","readwrite");
  tx.objectStore("prodotti").delete(id);
  tx.oncomplete=render;
}

function move(id,dir){
  const tx=db.transaction("prodotti","readwrite");
  const st=tx.objectStore("prodotti");
  st.get(id).onsuccess=e=>{
    const p=e.target.result;
    const idx=st.index("ordine");
    idx.openCursor().onsuccess=x=>{
      const c=x.target.result;
      if(c && c.value.ordine===p.ordine+dir){
        const o=c.value;
        [p.ordine,o.ordine]=[o.ordine,p.ordine];
        st.put(o); st.put(p);
      }
    };
  };
  tx.oncomplete=render;
}
</script>
</body>
</html>
